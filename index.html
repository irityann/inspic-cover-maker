<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iNSPiC カバーメーカー(非公式)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        .disclaimer { font-size: 11px; color: #888; margin-bottom: 10px; }
        .canvas-wrapper { display: inline-block; padding: 10px; background: #fff; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .controls { margin-top: 20px; background: white; padding: 20px; border-radius: 15px; display: inline-block; }
        .color-picker { margin: 10px 0; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; font-weight: bold; margin: 5px; }
        input[type="color"] { width: 50px; height: 30px; vertical-align: middle; cursor: pointer; }
    </style>
</head>
<body>

    <h1>iNSPiC カバーメーカー</h1>
    <p class="disclaimer">※非公式：穴なしプレートタイプ用 (120x84mm)</p>
    
    <div class="canvas-wrapper">
        <canvas id="canvas"></canvas>
    </div>

    <div class="controls">
        <div class="color-picker">
            背景色：<input type="color" id="bgColor" value="#ffffff">
        </div>
        <input type="file" id="imageInput" accept="image/*"><br><br>
        <button id="download">デザインを保存 (PNG)</button>
    </div>

    <script>
        const canvas = new fabric.Canvas('canvas', {
            width: 453,
            height: 317,
            backgroundColor: '#ffffff'
        });

        // 本体シェイプ（角丸）
        const inspicShell = new fabric.Rect({
            left: 0, top: 0, width: 453, height: 317, rx: 20, ry: 20,
            fill: 'transparent', stroke: '#e0e0e0', strokeWidth: 2, selectable: false, evented: false
        });

        // 裁断ガイド（点線）
        const cutLine = new fabric.Rect({
            left: 5, top: 5, width: 443, height: 307, rx: 18, ry: 18,
            fill: 'transparent', stroke: '#ff4757', strokeDashArray: [5, 5], selectable: false, evented: false
        });

        canvas.add(inspicShell);
        canvas.add(cutLine);

        // 背景色の変更
        document.getElementById('bgColor').oninput = function() {
            canvas.setBackgroundColor(this.value, canvas.renderAll.bind(canvas));
        };

        // 画像の読み込み
        document.getElementById('imageInput').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    img.scaleToWidth(200);
                    canvas.add(img);
                    // ガイド線より背面、背景色より前面へ
                    img.moveTo(1); 
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                });
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // 保存
        document.getElementById('download').onclick = function() {
            inspicShell.set('visible', false);
            cutLine.set('visible', false);
            canvas.renderAll();
            const dataURL = canvas.toDataURL({ format: 'png', quality: 1 });
            const link = document.createElement('a');
            link.download = 'inspic-custom.png';
            link.href = dataURL;
            link.click();
            inspicShell.set('visible', true);
            cutLine.set('visible', true);
            canvas.renderAll();
        };
    </script>
</body>
</html>
